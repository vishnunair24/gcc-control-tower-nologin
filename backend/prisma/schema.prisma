// ==============================
// Prisma Generator
// ==============================
generator client {
  provider = "prisma-client-js"
}

// ==============================
// Database Connection
// ==============================
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================
// SHARED ENUMS (USERS & ACCESS)
// ==============================

enum Role {
  ADMIN
  EMPLOYEE
  CUSTOMER
}

enum UserStatus {
  PENDING
  APPROVED
  REJECTED
}

// ==============================
// PROGRAM TRACKER (EXISTING)
// ==============================
model Task {
  id          Int      @id @default(autoincrement())
  workstream  String
  deliverable String
  status      String
  duration    Int
  startDate   DateTime
  endDate     DateTime
  progress    Int
  phase       String
  milestone   String
  owner       String

  // Optional customer scoping (null = legacy/global)
  customerName String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ==============================
// INFRA SETUP TRACKER (UPDATED)
// ==============================
model InfraTask {
  id              Int      @id @default(autoincrement())

  infraPhase      String
  taskName        String
  status          String
  percentComplete Int

  startDate       DateTime
  endDate         DateTime

  owner           String

  // Optional customer scoping (null = legacy/global)
  customerName String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ==============================
// TA DATA MODEL (NEW)
// ==============================

// Requisition-level view (demand, status)
model TARequisition {
  id                     Int      @id @default(autoincrement())
  requisitionId          String   // Business key from Excel (Job ID)
  jobTitle               String
  technology             String?
  hiringManager          String?
  recruiter              String?
  approvedPositions      Int      @default(0)
  priority               String?
  requisitionStatus      String   // Open / On Hold / Cancelled / Closed etc.
  requisitionCreatedDate DateTime?
  targetClosureDate      DateTime?
  location               String?
  businessUnit           String?

  // Optional customer scoping (null = legacy/global)
  customerName           String?

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

// Candidate-level view (per requisition)
model TACandidate {
  id                 Int      @id @default(autoincrement())
  candidateId        String   // Business key from Excel
  requisitionId      String   // Links back to TARequisition.requisitionId (no FK enforced)
  candidateName      String
  recruiter          String?
  source             String?
  profileReceivedDate DateTime?
  profileStatus      String?
  currentStage       String?
  stageEntryDate     DateTime?
  candidateStatus    String?

  // Optional customer scoping (null = legacy/global)
  customerName       String?

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

// Interview events and TAT
model TAInterview {
  id             Int      @id @default(autoincrement())
  interviewId    String?  // Optional business key
  candidateId    String
  requisitionId  String
  interviewRound String?
  interviewDate  DateTime?
  feedbackDate   DateTime?
  interviewResult String?
  interviewer    String?

  // Optional customer scoping (null = legacy/global)
  customerName   String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// Offer lifecycle
model TAOffer {
  id                Int      @id @default(autoincrement())
  offerId           String?  // Optional business key
  candidateId       String
  requisitionId     String
  offerReleasedDate DateTime?
  offerStatus       String?  // Accepted / Pending / Declined
  offerAcceptedDate DateTime?
  expectedDoj       DateTime?
  actualDoj         DateTime?
  declineReason     String?

  // Optional customer scoping (null = legacy/global)
  customerName      String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// Joiner pipeline
model TAJoiner {
  id             Int      @id @default(autoincrement())
  joinerId       String?  // Optional business key
  candidateId    String
  requisitionId  String
  joiningDate    DateTime?
  joiningStatus  String?  // Joined / No Show
  onboardingStatus String?

  // Optional customer scoping (null = legacy/global)
  customerName     String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// Monthly aggregate snapshot for TA exec dashboard
model TAExecMonthly {
  id               Int    @id @default(autoincrement())
  snapshotMonth    String // e.g. "Jan-2026"
  technology       String?
  totalApproved    Int    @default(0)
  joined           Int    @default(0)
  offersAccepted   Int    @default(0)
  offersInProcess  Int    @default(0)
  offersDeclined   Int    @default(0)
  openActive       Int    @default(0)
  onHold           Int    @default(0)
  cancelled        Int    @default(0)

  // Optional customer scoping (null = legacy/global)
  customerName     String?
}

// Monthly recruiter productivity snapshot
model TARecruiterMonthly {
  id                 Int    @id @default(autoincrement())
  snapshotMonth      String // e.g. "Jan-2026"
  recruiter          String
  positionsAssigned  Int    @default(0)
  profilesSubmitted  Int    @default(0)
  interviewsScheduled Int   @default(0)
  offersReleased     Int    @default(0)
  joiners            Int    @default(0)
  avgTatDays         Float  @default(0)
  
  // Optional customer scoping (null = legacy/global)
  customerName       String?
}

// ==============================
// USER MANAGEMENT & AUTH
// ==============================

model User {
  id        Int        @id @default(autoincrement())

  name      String
  email     String     @unique
  role      Role

  // For CUSTOMER role, this will be mandatory at signup (enforced in app layer).
  customerName String?

  phone     String?
  country   String?
  place     String?

  status    UserStatus @default(PENDING)

  // Password & reset
  passwordHash       String?
  resetToken         String?
  resetTokenExpires  DateTime?

  // Security questions for password recovery
  securityQuestion1    String?
  securityAnswer1Hash  String?
  securityQuestion2    String?
  securityAnswer2Hash  String?
  securityQuestion3    String?
  securityAnswer3Hash  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
